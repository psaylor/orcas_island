define(["jquery","sharedAudio","utils","sharedSocket"],function(e,t,n,r){console.log("> Loading recorder.js");var i=t.audioContext,s=r.ioStream,o=function(t,n){if(!(this instanceof o))return new o(t,n);console.log("Creating new Recorder on element",t),n=n||{},this.settings=e.extend({},o.DEFAULTS,n),this.recordBtn=e(t),this.socket=r.getSocket(this.settings.socketConfig),this.$this=e(this),this.recording=!1,this.binaryAudioStream=null,this.audioMetadata=this.settings.audioMetadata,this.audioMetadata.sampleRate=i.sampleRate,console.log("Recorder AudioMetaData:",this.audioMetadata),this._setupAudioNodes();var s=this;this.recordBtn.click(function(){s.toggle.call(s)}),this.socket.on("audioStreamResult",function(e){console.log("Recorder firing audio stream result for",e),s.$this.trigger("result.spoke.recorder",[e])})};return o.DEFAULTS={bufferLength:2048,bufferConversion:n.convertFloat32ToInt16,socketioEvents:{emitAudioStream:"audioStream"},socketConfig:{socketPath:"",socketUrl:"/"},audioMetadata:{}},o.ioStream=s,o.prototype._setupAudioNodes=function(){var e=this;this.scriptRecorderNode=i.createScriptProcessor(this.settings.bufferLength,1,1),this.scriptRecorderNode.onaudioprocess=function(n){e._recorderProcess.call(e,n)}},o.prototype._setupStream=function(e){console.log("Setting up new stream"),this.binaryAudioStream=s.createStream();var t=this.settings.socketioEvents.emitAudioStream;s(this.socket).emit(t,this.binaryAudioStream,this.audioMetadata)},o.prototype._recorderProcess=function(e){var t=e.inputBuffer.getChannelData(0),n=this.settings.bufferConversion(t);this.binaryAudioStream.writeAudio(n)},o.prototype.startRecording=function(){this.recording=!0,console.log(this.$this,this.$this.trigger),this.$this.trigger("start.spoke.recorder"),this.scriptRecorderNode.connect(i.destination),console.log("Setting up recorder.");var e=this;t.audioStreamPromise.then(function(t){console.log("Then got audioStreamSource for recorder"),t.connect(e.scriptRecorderNode),console.log("Recorder started")}).catch(function(t){console.log("Audio streaming error in recorder:",t),e.stop()})},o.prototype.stopRecording=function(){this.scriptRecorderNode.disconnect(),this.binaryAudioStream.end(),this.binaryAudioStream=null,this.recording=!1,this.$this.trigger("stop.spoke.recorder")},o.prototype.toggle=function(){this.recording?(console.log("Disconnecting recorder"),this.stopRecording()):(console.log("Starting recorder"),this._setupStream(),this.startRecording())},o.prototype.on=function(e,t,n){return this.$this.on(e,t,n)},o});